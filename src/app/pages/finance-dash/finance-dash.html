<div class="dashboard-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <app-nav-shop></app-nav-shop>

    <div class="p-4 border-t">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">
        A
      </div>
      <div class="flex flex-col">
        <span class="text-sm font-semibold text-black">Admin</span>
        <span class="text-xs text-gray-500">G√©rant</span>
      </div>
    </div>
  </div>
  </aside>

  <!-- MAIN -->
  <!-- MAIN -->
   <main class="main-content">

    <!-- TOPBAR -->
    <div class="topbar">
      <div>
      
        <h1 class="page-title">Gestion financi√®re</h1>
        <span class="page-date">{{ today | date:'EEEE d MMMM yyyy' }}</span>
      </div>
     
    </div>

    <!-- KPI -->
    <div class="kpi-row">
      <div class="kpi-card purple">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">Chiffre d'affaires</div>
        <div class="kpi-value">{{ totalRevenue | number }} Ar</div>
      </div>
      <div class="kpi-card teal">
        <div class="kpi-icon">üì¶</div>
        <div class="kpi-label">Produits</div>
        <div class="kpi-value">{{ products.length }}</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-icon">üõí</div>
        <div class="kpi-label">Commandes</div>
        <div class="kpi-value">{{ orders.length }}</div>
      </div>
      <div class="kpi-card gold">
        <div class="kpi-icon">üèÜ</div>
        <div class="kpi-label">Top produit</div>
        <div class="kpi-value small">{{ bestSellingProduct }}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-head card-head--top">
        <div>
          <h3 class="card-title">Gestion des Stocks</h3>
          <p class="card-sub">Produits, prix, promotions et stocks</p>
        </div>
        <button class="btn btn-primary" (click)="openAddModal()">+ Nouveau produit</button>
      </div>
      <!-- Le formulaire inline est remplac√© par une modale √©l√©gante -->

      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Cat√©gorie</th>
              <th class="th-center">Stock</th>
              <th class="th-right">Prix</th>
              <th class="th-center">Promotion</th>
              <th class="th-center">Statut</th>
              <th class="th-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of products">
              <td>{{ p.name }}</td>
              <td>{{ p.category }}</td>
              <td class="td-center">{{ p.stock }}</td>
              <td class="td-right">
                {{ p.price | number }} Ar
                <div *ngIf="p.promoActive">
                  ‚Üí {{ discountedPrice(p) | number }} Ar (‚àí{{ p.discountPercent }}%)
                </div>
              </td>
              <td class="td-center">
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="p.promoActive">
                  <span class="slider"></span>
                </label>
                <input type="number" min="0" max="90" [(ngModel)]="p.discountPercent" class="pct-input">
              </td>
              <td class="td-center">
                <span class="badge"
                      [class.low]="p.stock < 5"
                      [class.ok]="p.stock >= 5">
                  {{ p.stock < 5 ? 'Stock faible' : 'Disponible' }}
                </span>
              </td>
              <td class="td-center">
                <button class="action delete" (click)="deleteProduct(p.id)">Suppr.</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïî‚ïê Commandes re√ßues ‚ïê‚ïê‚ïê -->
    <div class="card">
      <div class="card-head card-head--top">
        <div>
          <h3 class="card-title">Commandes Re√ßues</h3>
          <p class="card-sub">Suivi des commandes et mise √† jour des statuts</p>
        </div>
      </div>

      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Commande</th>
              <th>Client</th>
              <th>Produits</th>
              <th class="th-center">Qt√©</th>
              <th class="th-center">Date</th>
              <th class="th-right">Total</th>
              <th class="th-center">Statut</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let o of orders">
              <td>#{{ o.id }}</td>
              <td>{{ o.customer }}</td>
              <td>
                <span *ngFor="let it of o.items; let k = index">
                  {{ it.name }}√ó{{ it.qty }}<span *ngIf="k < o.items.length - 1">, </span>
                </span>
              </td>
              <td class="td-center">{{ o.qty }}</td>
              <td class="td-center">{{ o.date | date:'dd MMM yyyy' }}</td>
              <td class="td-right">{{ o.total | number }} Ar</td>
              <td class="td-center">
                <div class="order-status-wrap">
                  <span class="badge-order"
                        [class.pending]="o.status === 'En attente'"
                        [class.confirmed]="o.status === 'Confirm√©e'"
                        [class.delivered]="o.status === 'Livr√©e'">
                    {{ o.status === 'En attente' ? 'En attente' : o.status === 'Confirm√©e' ? 'Confirm√©e' : 'Livr√©e' }}
                  </span>
                  <div class="status-actions">
                    <button class="s-btn s-pending" (click)="setOrderStatus(o,'En attente')">En attente</button>
                    <button class="s-btn s-confirmed" (click)="setOrderStatus(o,'Confirm√©e')">Confirm√©e</button>
                    <button class="s-btn s-delivered" (click)="setOrderStatus(o,'Livr√©e')">Livr√©e</button>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïî‚ïê Historique des ventes ‚ïê‚ïê‚ïê -->
    <div class="card">
      <div class="card-head card-head--top">
        <div>
          <h3 class="card-title">Historique des Ventes</h3>
          <p class="card-sub">Commandes livr√©es uniquement</p>
        </div>
      </div>

      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-val">{{ totalRevenue | number }} Ar</span>
          <span class="stat-label">Chiffre d'affaires</span>
        </div>
        <div class="stat-item">
          <span class="stat-val">{{ totalDelivered }}</span>
          <span class="stat-label">Commandes livr√©es</span>
        </div>
        <div class="stat-item stat-item--wide">
          <span class="stat-val stat-val--sm">{{ bestSellingProduct }}</span>
          <span class="stat-label">Meilleur produit</span>
        </div>
      </div>

      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Produits</th>
              <th class="th-center">Qt√©</th>
              <th class="th-right">Montant</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of salesHistory">
              <td class="td-muted">{{ s.date | date:'dd MMM yyyy' }}</td>
              <td class="td-muted td-truncate">
                <span *ngFor="let it of s.items; let k = index">
                  {{ it.name }}√ó{{ it.qty }}<span *ngIf="k < s.items.length - 1">, </span>
                </span>
              </td>
              <td class="td-center">{{ s.qty }}</td>
              <td class="td-right">{{ s.total | number }} Ar</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<!-- ===== MODALE AJOUT PRODUIT ===== -->
<div class="modal-overlay" *ngIf="addModalOpen" (click)="closeAddModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-head">
      <h3 class="modal-title">Nouveau produit</h3>
      <button class="modal-close" (click)="closeAddModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="form-field">
          <label>Image</label>
          <input type="file" accept="image/*" (change)="onImageSelected($event)"/>
          <div *ngIf="imagePreview" style="margin-top:8px">
            <img [src]="imagePreview" alt="Aper√ßu" style="max-height:120px;border-radius:10px;border:1px solid #e5e7eb"/>
          </div>
        </div>
        <div class="form-field">
          <label>Nom</label>
          <input [(ngModel)]="newProduct.name" placeholder="Nom du produit" />
        </div>
        <div class="form-field">
          <label>Description</label>
          <input [(ngModel)]="newProduct.description" placeholder="Courte description" />
        </div>
        <div class="form-field">
          <label>Cat√©gorie</label>
          <input [(ngModel)]="newProduct.category" placeholder="Cat√©gorie" />
        </div>
        <div class="form-field">
          <label>Couleur</label>
          <input [(ngModel)]="newProduct.couleur" placeholder="Couleur (ex: Noir)" />
        </div>
        <div class="form-field">
          <label>Stock</label>
          <input type="number" [(ngModel)]="newProduct.stock" placeholder="0" />
        </div>
        <div class="form-field">
          <label>Prix (Ar)</label>
          <input type="number" [(ngModel)]="newProduct.price" placeholder="0" />
        </div>
        <div class="form-field">
          <label>Promotion (%)</label>
          <input type="number" min="0" max="90" [(ngModel)]="newProduct.discountPercent" placeholder="0" />
        </div>
        <div class="form-field form-field--toggle">
          <label>Activer la promo</label>
          <label class="toggle">
            <input type="checkbox" [(ngModel)]="newProduct.promoActive">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" (click)="closeAddModal()">Annuler</button>
      <button class="btn btn-primary" [disabled]="!canSubmitProduct" (click)="submitAddProduct()">Ajouter</button>
    </div>
  </div>
</div>
